<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Dashboard - <%= guildName %></title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #111827;
      --bg-card: #1a1f2e;
      --bg-card-hover: #232a3d;
      --bg-input: #0d1117;
      --border-color: #2d3748;
      --border-glow: rgba(139, 92, 246, 0.3);
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent-purple: #8b5cf6;
      --accent-purple-glow: rgba(139, 92, 246, 0.4);
      --accent-blue: #3b82f6;
      --tank-color: #3b82f6;
      --tank-bg: rgba(59, 130, 246, 0.15);
      --healer-color: #22c55e;
      --healer-bg: rgba(34, 197, 94, 0.15);
      --dps-color: #ef4444;
      --dps-bg: rgba(239, 68, 68, 0.15);
      --success-color: #22c55e;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --gold-color: #fbbf24;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      background-image:
        radial-gradient(ellipse at top, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(59, 130, 246, 0.08) 0%, transparent 50%);
      min-height: 100vh;
      color: var(--text-primary);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      padding: 24px 30px;
      border-radius: 16px;
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--accent-purple);
      box-shadow: 0 0 20px var(--accent-purple-glow);
    }

    .user-info h1 {
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .user-info .guild-name {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: var(--bg-secondary);
      padding: 8px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .tab-btn {
      flex: 1;
      padding: 14px 24px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-btn:hover {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--accent-purple), #6366f1);
      color: white;
      box-shadow: 0 4px 15px var(--accent-purple-glow);
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Cards */
    .card {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 20px;
      background: linear-gradient(180deg, var(--accent-purple), var(--accent-blue));
      border-radius: 2px;
    }

    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .info-item {
      background: var(--bg-card);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .info-item label {
      display: block;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .info-item .value {
      color: var(--text-primary);
      font-size: 18px;
      font-weight: 600;
    }

    .info-item .value.role-tank { color: var(--tank-color); }
    .info-item .value.role-healer { color: var(--healer-color); }
    .info-item .value.role-dps { color: var(--dps-color); }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .stat-card {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      text-align: center;
    }

    .stat-card .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent-purple);
      margin-bottom: 4px;
    }

    .stat-card .stat-label {
      color: var(--text-secondary);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      color: var(--text-secondary);
      font-size: 13px;
      margin-bottom: 8px;
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--accent-purple);
      box-shadow: 0 0 0 3px var(--accent-purple-glow);
    }

    select.form-control {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-purple), #6366f1);
      color: white;
      box-shadow: 0 4px 15px var(--accent-purple-glow);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--accent-purple-glow);
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent-purple);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-warning {
      background: var(--warning-color);
      color: #1a1a1a;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Events Calendar */
    .events-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .event-card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .event-card:hover {
      border-color: var(--accent-purple);
      transform: translateY(-2px);
    }

    .event-card-header {
      display: flex;
      align-items: center;
      padding: 16px;
      gap: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .event-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: var(--bg-secondary);
    }

    .event-info {
      flex: 1;
    }

    .event-info h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .event-info .event-time {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .event-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .event-status.attending { background: var(--healer-bg); color: var(--healer-color); }
    .event-status.not-attending { background: var(--dps-bg); color: var(--dps-color); }
    .event-status.maybe { background: rgba(251, 191, 36, 0.15); color: var(--warning-color); }
    .event-status.recorded { background: var(--accent-purple-glow); color: var(--accent-purple); }

    .event-card-body {
      padding: 16px;
    }

    .event-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .event-actions .btn {
      padding: 8px 16px;
      font-size: 13px;
    }

    .attendance-form {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .attendance-form input {
      flex: 1;
      max-width: 150px;
    }

    /* Wishlist */
    .wishlist-section {
      margin-bottom: 24px;
    }

    .wishlist-section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .wishlist-section-title .limit {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: normal;
    }

    .wishlist-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }

    .wishlist-item {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .wishlist-item:hover {
      border-color: var(--accent-purple);
      transform: translateY(-2px);
    }

    .wishlist-item.selected {
      border-color: var(--success-color);
      background: rgba(34, 197, 94, 0.1);
    }

    .wishlist-item.received {
      border-color: var(--gold-color);
      background: rgba(251, 191, 36, 0.1);
    }

    .wishlist-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .wishlist-item img {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: var(--bg-secondary);
    }

    .wishlist-item .item-name {
      font-size: 12px;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .wishlist-item .item-category {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .wishlist-item .received-badge {
      margin-top: 8px;
      padding: 4px 8px;
      background: var(--gold-color);
      color: #1a1a1a;
      font-size: 10px;
      font-weight: 600;
      border-radius: 4px;
    }

    .wishlist-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 14px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success { border-color: var(--success-color); }
    .toast.error { border-color: var(--danger-color); }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .loading::after {
      content: '';
      width: 24px;
      height: 24px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Gear Screenshot */
    .gear-screenshot {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-top: 12px;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h2 {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }

      .tab-nav {
        flex-direction: column;
      }

      .info-grid {
        grid-template-columns: 1fr;
      }

      .wishlist-items {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Static Events */
    .static-events {
      margin-top: 24px;
    }

    .static-event-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .static-event-day {
      background: var(--accent-purple);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 12px;
      min-width: 60px;
      text-align: center;
    }

    /* No events message */
    .no-events {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .no-events-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    /* Roster Table */
    .roster-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .roster-table th {
      text-align: left;
      padding: 12px;
      background: var(--bg-card);
      border-bottom: 2px solid var(--border-color);
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
    }

    .roster-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    .roster-table tr:hover {
      background: var(--bg-card);
    }

    .roster-player-name {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .roster-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border-color);
    }

    .roster-role-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .roster-role-tank {
      background: var(--tank-bg);
      color: var(--tank-color);
      border: 1px solid var(--tank-color);
    }

    .roster-role-healer {
      background: var(--healer-bg);
      color: var(--healer-color);
      border: 1px solid var(--healer-color);
    }

    .roster-role-dps {
      background: var(--dps-bg);
      color: var(--dps-color);
      border: 1px solid var(--dps-color);
    }

    .roster-cp {
      font-weight: 600;
      color: var(--gold-color);
    }

    .roster-weapons {
      color: var(--text-secondary);
    }

    .roster-stat {
      text-align: center;
    }

    .roster-attendance-good { color: var(--success-color); }
    .roster-attendance-medium { color: var(--warning-color); }
    .roster-attendance-low { color: var(--danger-color); }

    .roster-sort-btn.active {
      background: linear-gradient(135deg, var(--accent-purple), #6366f1);
      color: white;
      border-color: transparent;
    }

    .roster-sort-btn .sort-arrow {
      margin-left: 4px;
      font-size: 10px;
    }

    .roster-sort-btn:not(.active) .sort-arrow {
      display: none;
    }

    .roster-summary {
      display: flex;
      gap: 24px;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg-card);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .roster-summary-item {
      text-align: center;
    }

    .roster-summary-value {
      font-size: 24px;
      font-weight: 700;
    }

    .roster-summary-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    @media (max-width: 768px) {
      .roster-table {
        font-size: 12px;
      }

      .roster-table th, .roster-table td {
        padding: 8px;
      }

      .roster-avatar {
        width: 24px;
        height: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <% if (userAvatar) { %>
        <img src="<%= userAvatar %>" alt="Avatar" class="user-avatar">
      <% } %>
      <div class="user-info">
        <h1><%= userName %></h1>
        <p class="guild-name"><%= guildName %></p>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="info">
        <span>My Info</span>
      </button>
      <button class="tab-btn" data-tab="events">
        <span>Events</span>
      </button>
      <button class="tab-btn" data-tab="wishlist">
        <span>Wishlist</span>
      </button>
      <button class="tab-btn" data-tab="roster">
        <span>Roster</span>
      </button>
    </div>

    <!-- My Info Tab -->
    <div id="tab-info" class="tab-content active">
      <div class="card">
        <h2 class="card-title">Character Information</h2>
        <div id="info-content">
          <div class="loading">Loading...</div>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">Statistics</h2>
        <div id="stats-content">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Events Tab -->
    <div id="tab-events" class="tab-content">
      <div class="card">
        <h2 class="card-title">Upcoming Events</h2>
        <div id="events-content">
          <div class="loading">Loading...</div>
        </div>
      </div>

      <div class="card static-events">
        <h2 class="card-title">Weekly Schedule</h2>
        <div id="static-events-content">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Wishlist Tab -->
    <div id="tab-wishlist" class="tab-content">
      <div class="card">
        <h2 class="card-title">Your Wishlist</h2>
        <div id="wishlist-status"></div>
        <div id="wishlist-content">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Roster Tab -->
    <div id="tab-roster" class="tab-content">
      <div class="card">
        <h2 class="card-title">Guild Roster</h2>
        <div class="roster-controls" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px;">
          <button class="btn btn-secondary roster-sort-btn active" data-sort="name">Name<span class="sort-arrow">‚ñ≤</span></button>
          <button class="btn btn-secondary roster-sort-btn" data-sort="cp">CP<span class="sort-arrow">‚ñº</span></button>
          <button class="btn btn-secondary roster-sort-btn" data-sort="role">Role<span class="sort-arrow">‚ñ≤</span></button>
          <button class="btn btn-secondary roster-sort-btn" data-sort="classes">Classes<span class="sort-arrow">‚ñ≤</span></button>
          <button class="btn btn-secondary roster-sort-btn" data-sort="totalEvents">Total Events<span class="sort-arrow">‚ñº</span></button>
          <button class="btn btn-secondary roster-sort-btn" data-sort="attendance">Attendance<span class="sort-arrow">‚ñº</span></button>
        </div>
        <div id="roster-content">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Attendance Code Modal -->
  <div id="attendance-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>Record Attendance</h2>
        <button class="modal-close" onclick="closeAttendanceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Enter Attendance Code</label>
          <input type="text" id="attendance-code" class="form-control" placeholder="4-digit code" maxlength="4">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAttendanceModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitAttendance()">Submit</button>
      </div>
    </div>
  </div>

  <script>
    const TOKEN = '<%= token %>';
    const WEAPONS = [
      { name: 'Orb', emoji: '' },
      { name: 'Wand', emoji: '' },
      { name: 'SnS', emoji: '' },
      { name: 'Greatsword', emoji: '' },
      { name: 'Staff', emoji: '' },
      { name: 'Bow', emoji: '' },
      { name: 'Crossbows', emoji: '' },
      { name: 'Daggers', emoji: '' },
      { name: 'Spear', emoji: '' }
    ];

    // Item database
    const WISHLIST_ITEMS = {
      archbossWeapons: [
        { id: 'bellandir_blade', name: "Queen Bellandir's Languishing Blade", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword_00034.webp', category: 'Sword & Shield' },
        { id: 'deluzhnoa_edge', name: "Deluzhnoa's Edge of Eternal Frost", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword_00052.webp', category: 'Sword & Shield' },
        { id: 'cordy_warblade', name: "Cordy's Warblade of Creeping Doom", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword2h_00052.webp', category: 'Greatsword' },
        { id: 'tevent_warblade', name: "Tevent's Warblade of Despair", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword2h_00036.webp', category: 'Greatsword' },
        { id: 'tevent_fangs', name: "Tevent's Fangs of Fury", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Dagger_00035.webp', category: 'Daggers' },
        { id: 'deluzhnoa_razors', name: "Deluzhnoa's Permafrost Razors", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Dagger_00052.webp', category: 'Daggers' },
        { id: 'tevent_arc', name: "Tevent's Arc of Wailing Death", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Bow_00018.webp', category: 'Bow' },
        { id: 'deluzhnoa_arc', name: "Deluzhnoa's Arc of Frozen Death", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Bow_00017.webp', category: 'Bow' },
        { id: 'bellandir_crossbow', name: "Queen Bellandir's Toxic Spine Throwers", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Crossbow_00033.webp', category: 'Crossbow' },
        { id: 'cordy_crossbow', name: "Cordy's Stormspore Spike Slingers", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Crossbow_00030.webp', category: 'Crossbow' },
        { id: 'tevent_wand', name: "Tevent's Grasp of Withering", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Wand_00011.webp', category: 'Wand' },
        { id: 'cordy_wand', name: "Cordy's Grasp of Manipulation", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Wand_00015.webp', category: 'Wand' },
        { id: 'bellandir_staff', name: "Queen Bellandir's Hivemind Staff", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Staff_00019.webp', category: 'Staff' },
        { id: 'deluzhnoa_staff', name: "Deluzhnoa's Ancient Petrified Staff", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Staff_00018A.webp', category: 'Staff' },
        { id: 'deluzhnoa_spear', name: "Deluzhnoa's Serrated Shard", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Spear_00026.webp', category: 'Spear' },
        { id: 'bellandir_spear', name: "Queen Bellandir's Serrated Spike", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Spear_00018.webp', category: 'Spear' },
        { id: 'tevent_orb', name: "Tevent's Omniscient Eye", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Orb_00014.webp', category: 'Orb' },
        { id: 'cordy_orb', name: "Cordy's Source of Contagion", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Orb_00019.webp', category: 'Orb' }
      ],
      archbossArmors: [
        { id: 'crimson_chestplate', name: 'Crimson Lotus Chestplate', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_PL_M_TS_00019B.webp', type: 'Chest Armor' },
        { id: 'veiled_gloves', name: 'Veiled Concord Gloves', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_LE_M_GL_00024.webp', type: 'Gloves' },
        { id: 'errant_brim', name: 'Errant Scion Brim', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_LE_M_HM_00022A.webp', type: 'Helmet' },
        { id: 'umbral_pants', name: 'Umbral Astarch Pants', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_LE_M_PT_00030.webp', type: 'Pants' },
        { id: 'blood_moon_cloak', name: 'Cloak of the Blood Moon', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_M_CA_00032.webp', type: 'Cloak' },
        { id: 'piercing_ice_cloak', name: 'Cloak of Piercing Ice', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_M_CA_00029.webp', type: 'Cloak' }
      ],
      t3Weapons: [
        { id: 'daigon_stormblade', name: "Daigon's Stormblade", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword_00017A.webp', category: 'Sword & Shield' },
        { id: 'chernobog_blade', name: "Chernobog's Cauterizing Blade", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword_00033A.webp', category: 'Sword & Shield' },
        { id: 'cornelius_blade', name: "Cornelius's Blade of Dancing Flame", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword_00008B.webp', category: 'Sword & Shield' },
        { id: 'nirma_sword', name: "Nirma's Sword of Falling Ash", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword_00035A.webp', category: 'Sword & Shield' },
        { id: 'ahzreil_sword', name: "Ahzreil's Soulless Sword", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword_00026B.webp', category: 'Sword & Shield' },
        { id: 'naru_greatblade', name: "Naru's Frenzied Greatblade", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword2h_00034.webp', category: 'Greatsword' },
        { id: 'morokai_greatblade', name: "Morokai's Soulfire Greatblade", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword2h_00027A.webp', category: 'Greatsword' },
        { id: 'adentus_greatsword', name: "Adentus's Cinderhulk Greatsword", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword2h_00028A.webp', category: 'Greatsword' },
        { id: 'junobote_blade', name: "Junobote's Blade of the Red Colossus", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Sword2h_00039A.webp', category: 'Greatsword' },
        { id: 'leviathan_tendrils', name: "Leviathan's Bladed Tendrils", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Dagger_00051.webp', category: 'Daggers' },
        { id: 'kowazan_daggers', name: "Kowazan's Daggers of the Blood Moon", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Dagger_00037A.webp', category: 'Daggers' },
        { id: 'minzerok_daggers', name: "Minzerok's Daggers of Flaying", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Dagger_00039A.webp', category: 'Daggers' },
        { id: 'leviathan_longbow', name: "Leviathan's Bloodstorm Longbow", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Bow_00051.webp', category: 'Bow' },
        { id: 'aelon_longbow', name: "Grand Aelon's Longbow of Blight", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Dagger_00035.webp', category: 'Bow' },
        { id: 'akman_crossbows', name: "Akman's Bloodletting Crossbows", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Crossbow_00031.webp', category: 'Crossbow' },
        { id: 'malakar_crossbows', name: "Malakar's Flamespike Crossbows", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Crossbow_00034A.webp', category: 'Crossbow' },
        { id: 'kowazan_crossbows', name: "Kowazan's Crossbows of the Eclipse", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Crossbow_00035A.webp', category: 'Crossbow' },
        { id: 'deckman_scepter', name: "Deckman's Balefire Scepter", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Wand_00003C.webp', category: 'Wand' },
        { id: 'excavator_scepter', name: "Excavator's Radiant Scepter", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Wand_00012A.webp', category: 'Wand' },
        { id: 'daigon_emberstaff', name: "Daigon's Charred Emberstaff", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_staff_00036.webp', category: 'Staff' },
        { id: 'talus_staff', name: "Talus's Incandescent Staff", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Staff_00032A.webp', category: 'Staff' },
        { id: 'aridus_voidstaff', name: "Aridus's Immolated Voidstaff", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Staff_00033A.webp', category: 'Staff' },
        { id: 'naru_spear', name: "Naru's Sawfang Spear", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Spear_00030.webp', category: 'Spear' },
        { id: 'junobote_ranseur', name: "Junobote's Extra Smoldering Ranseur", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Spear_00021A.webp', category: 'Spear' },
        { id: 'manticus_core', name: 'Manticus Fraternal Core', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Orb_00016.webp', category: 'Orb' },
        { id: 'talus_core', name: "Talus's Transcendent Core", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Weapon/IT_P_Orb_00009A.webp', category: 'Orb' }
      ],
      t3Armors: [
        { id: 'fallen_helmet', name: 'Fallen Dynasty Helmet', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Part_PL_M_HM_00018B.webp', type: 'Helmet' },
        { id: 'fallen_plate', name: 'Fallen Dynasty Plate Armor', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Part_PL_M_TS_00013A.webp', type: 'Chest Armor' },
        { id: 'fallen_legs', name: 'Fallen Dynasty Leg Plates', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_PL_M_PT_00010B.webp', type: 'Pants' },
        { id: 'fallen_sabatons', name: 'Fallen Dynasty Sabatons', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_PL_M_BT_00017A.webp', type: 'Boots' },
        { id: 'blood_hood', name: 'Blood Hunter Hood', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_LE_M_HM_05002A.webp', type: 'Helmet' },
        { id: 'blood_garb', name: 'Blood Hunter Garb', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Part_LE_M_TS_00018A.webp', type: 'Chest Armor' },
        { id: 'blood_guards', name: 'Blood Hunter Hand Guards', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_LE_M_GL_00022C.webp', type: 'Gloves' },
        { id: 'blood_boots', name: 'Blood Hunter Boots', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_LE_M_BT_00015A.webp', type: 'Boots' },
        { id: 'twilight_pants', name: 'Twilight Embrace Pants', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_FA_M_PT_00008C.webp', type: 'Pants' },
        { id: 'twilight_robes', name: 'Twilight Embrace Robes', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_FA_M_TS_00005C.webp', type: 'Chest Armor' },
        { id: 'twilight_gloves', name: 'Twilight Embrace Gloves', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_FA_M_GL_00001D.webp', type: 'Gloves' },
        { id: 'twilight_shoes', name: 'Twilight Embrace Shoes', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Armor/P_Set_FA_M_BT_00005C.webp', type: 'Boots' }
      ],
      t3Accessories: [
        { id: 'two_moons_earrings', name: 'Earrings of the Two Moons', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Acc/IT_P_Earring_00027.webp', type: 'Earring' },
        { id: 'venelux_earrings', name: "Venelux Scholar's Earrings", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Acc/IT_P_Earring_00028.webp', type: 'Earring' },
        { id: 'steadfast_belt', name: 'Belt of the Steadfast Pledge', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Acc/IT_P_Belt_00055.webp', type: 'Belt' },
        { id: 'rustling_sash', name: 'Sash of Rustling Leaves', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Acc/IT_P_Belt_00049.webp', type: 'Belt' },
        { id: 'unregretted_locket', name: 'Locket of Unregretted Sin', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Acc/IT_P_Necklace_00054.webp', type: 'Necklace' },
        { id: 'cold_revenge_wristlet', name: 'Wristlet of Cold Revenge', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Acc/IT_P_Bracelet_00051.webp', type: 'Bracelet' },
        { id: 'endless_breeze_bracelet', name: 'Endless Breeze Bracelet', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Acc/IT_P_Bracelet_00049.webp', type: 'Bracelet' },
        { id: 'davinci_ring', name: "DaVinci's Signet Ring", icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Acc/IT_P_Ring_00063.webp', type: 'Ring' },
        { id: 'brutal_agony_band', name: 'Band of Brutal Agony', icon: 'https://cdn.questlog.gg/throne-and-liberty/assets/Game/Image/Icon/Item_128/Equip/Acc/IT_P_Ring_00060.webp', type: 'Ring' }
      ]
    };

    const WISHLIST_LIMITS = {
      archbossWeapon: 1,
      archbossArmor: 1,
      t3Weapons: 1,
      t3Armors: 4,
      t3Accessories: 2
    };

    // State
    let profileData = null;
    let eventsData = null;
    let wishlistData = null;
    let currentAttendanceEventId = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupTabs();
      loadProfileData();
      loadEventsData();
      loadWishlistData();
      loadRosterData();
    });

    // Tab switching
    function setupTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;

          // Update buttons
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // Update content
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          document.getElementById(`tab-${tab}`).classList.add('active');

          // Refresh data when switching tabs to ensure fresh data
          switch (tab) {
            case 'info':
              loadProfileData();
              break;
            case 'events':
              loadEventsData();
              break;
            case 'wishlist':
              loadWishlistData();
              break;
            case 'roster':
              loadRosterData();
              break;
          }
        });
      });
    }

    // API calls with cache busting
    async function apiCall(endpoint, method = 'GET', data = null) {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache'
        },
        cache: 'no-store'
      };
      if (data) options.body = JSON.stringify(data);

      // Add timestamp to bust cache
      const separator = endpoint.includes('?') ? '&' : '?';
      const url = `/api/profile/${TOKEN}/${endpoint}${separator}_t=${Date.now()}`;

      const response = await fetch(url, options);
      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Request failed');
      }

      return result;
    }

    // Load profile data
    async function loadProfileData() {
      try {
        profileData = await apiCall('data');
        renderProfileInfo();
        renderStats();
      } catch (error) {
        console.error('Error loading profile:', error);
        document.getElementById('info-content').innerHTML = '<p class="error">Failed to load profile data</p>';
      }
    }

    // Render profile info
    function renderProfileInfo() {
      const info = profileData.playerInfo;
      const roleClass = info.role ? `role-${info.role}` : '';

      const html = `
        <div class="info-grid">
          <div class="info-item">
            <label>Role</label>
            <div class="value ${roleClass}">${info.role ? info.role.charAt(0).toUpperCase() + info.role.slice(1) : 'Not Set'}</div>
          </div>
          <div class="info-item">
            <label>Primary Weapon</label>
            <div class="value">${info.weapon1 || 'Not Set'}</div>
          </div>
          <div class="info-item">
            <label>Secondary Weapon</label>
            <div class="value">${info.weapon2 || 'Not Set'}</div>
          </div>
          <div class="info-item">
            <label>Combat Power</label>
            <div class="value">${info.cp ? info.cp.toLocaleString() : 'Not Set'}</div>
          </div>
          <div class="info-item">
            <label>Static Party</label>
            <div class="value">${profileData.partyNumber ? 'Party ' + profileData.partyNumber : 'Not Assigned'}</div>
          </div>
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
          <h3 style="font-size: 16px; margin-bottom: 16px;">Edit Information</h3>
          <form id="info-form" onsubmit="saveProfileInfo(event)">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div class="form-group">
                <label>Primary Weapon</label>
                <select class="form-control" id="edit-weapon1">
                  <option value="">Select Weapon</option>
                  ${WEAPONS.map(w => `<option value="${w.name}" ${info.weapon1 === w.name ? 'selected' : ''}>${w.name}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>Secondary Weapon</label>
                <select class="form-control" id="edit-weapon2">
                  <option value="">Select Weapon</option>
                  ${WEAPONS.map(w => `<option value="${w.name}" ${info.weapon2 === w.name ? 'selected' : ''}>${w.name}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>Combat Power</label>
                <input type="number" class="form-control" id="edit-cp" value="${info.cp || ''}" min="0" max="10000000" placeholder="Enter CP">
              </div>
              <div class="form-group">
                <label>Build Link</label>
                <input type="url" class="form-control" id="edit-buildlink" value="${info.buildLink || ''}" placeholder="https://...">
              </div>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 16px;">Save Changes</button>
          </form>
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
          <h3 style="font-size: 16px; margin-bottom: 16px;">Gear Screenshot</h3>
          ${info.gearScreenshotUrl ? `
            <img src="${info.gearScreenshotUrl}" alt="Gear Screenshot" class="gear-screenshot" style="margin-bottom: 16px;">
          ` : `
            <p style="color: var(--text-secondary); margin-bottom: 16px;">No gear screenshot uploaded yet.</p>
          `}
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <input type="file" id="gear-file-input" accept="image/png,image/jpg,image/jpeg,image/webp,image/gif" style="display: none;">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('gear-file-input').click()">
              ${info.gearScreenshotUrl ? 'Update Screenshot' : 'Upload Screenshot'}
            </button>
            <span id="gear-upload-status" style="color: var(--text-secondary); font-size: 13px;"></span>
          </div>
        </div>
      `;

      document.getElementById('info-content').innerHTML = html;

      // Setup gear file input listener
      document.getElementById('gear-file-input').addEventListener('change', handleGearFileSelect);
    }

    // Save profile info
    async function saveProfileInfo(e) {
      e.preventDefault();

      const data = {
        weapon1: document.getElementById('edit-weapon1').value || undefined,
        weapon2: document.getElementById('edit-weapon2').value || undefined,
        cp: document.getElementById('edit-cp').value ? parseInt(document.getElementById('edit-cp').value) : undefined,
        buildLink: document.getElementById('edit-buildlink').value || undefined
      };

      try {
        await apiCall('update-info', 'POST', data);
        showToast('Profile updated successfully', 'success');
        await loadProfileData();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Handle gear file selection and upload
    async function handleGearFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      const validTypes = ['image/png', 'image/jpg', 'image/jpeg', 'image/webp', 'image/gif'];
      if (!validTypes.includes(file.type)) {
        showToast('Please select a valid image file (PNG, JPG, WEBP, GIF)', 'error');
        return;
      }

      // Validate file size (max 8MB)
      if (file.size > 8 * 1024 * 1024) {
        showToast('Image is too large. Maximum size is 8MB.', 'error');
        return;
      }

      const statusEl = document.getElementById('gear-upload-status');
      statusEl.textContent = 'Uploading...';
      statusEl.style.color = 'var(--text-secondary)';

      try {
        // Convert to base64
        const reader = new FileReader();
        reader.onload = async function(event) {
          const imageData = event.target.result;

          try {
            const result = await apiCall('upload-gear', 'POST', { imageData });
            showToast('Gear screenshot uploaded successfully!', 'success');
            statusEl.textContent = '';
            await loadProfileData();
          } catch (error) {
            showToast(error.message, 'error');
            statusEl.textContent = 'Upload failed';
            statusEl.style.color = 'var(--danger-color)';
          }
        };
        reader.onerror = function() {
          showToast('Failed to read file', 'error');
          statusEl.textContent = 'Upload failed';
          statusEl.style.color = 'var(--danger-color)';
        };
        reader.readAsDataURL(file);
      } catch (error) {
        showToast('Failed to upload screenshot', 'error');
        statusEl.textContent = 'Upload failed';
        statusEl.style.color = 'var(--danger-color)';
      }
    }

    // Render stats
    function renderStats() {
      const bonuses = profileData.bonuses;
      const weeklyAttendance = profileData.weeklyTotalEvents > 0
        ? Math.round((bonuses.eventsAttended / profileData.weeklyTotalEvents) * 100)
        : 0;

      const html = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">${profileData.totalEvents}</div>
            <div class="stat-label">Total PvP Events</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${bonuses.eventsAttended || 0}</div>
            <div class="stat-label">Weekly Attendance</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${bonuses.bonusCount || 0}</div>
            <div class="stat-label">Weekly Bonus</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${weeklyAttendance}%</div>
            <div class="stat-label">Attendance Rate</div>
          </div>
        </div>
      `;

      document.getElementById('stats-content').innerHTML = html;
    }

    // Load events data
    async function loadEventsData() {
      try {
        eventsData = await apiCall('events');
        renderEvents();
        renderStaticEvents();
      } catch (error) {
        console.error('Error loading events:', error);
        document.getElementById('events-content').innerHTML = '<p class="error">Failed to load events</p>';
      }
    }

    // Render events
    function renderEvents() {
      if (!eventsData.events || eventsData.events.length === 0) {
        document.getElementById('events-content').innerHTML = `
          <div class="no-events">
            <div class="no-events-icon">üìÖ</div>
            <p>No upcoming events</p>
          </div>
        `;
        return;
      }

      const eventTypeIcons = {
        siege: 'üè∞',
        riftstone: 'üíé',
        boonstone: 'üîÆ',
        wargames: '‚öîÔ∏è',
        warboss: 'üëπ',
        guildevent: 'üé™'
      };

      const eventTypeNames = {
        siege: 'Siege',
        riftstone: 'Riftstone',
        boonstone: 'Boonstone',
        wargames: 'Wargames',
        warboss: 'War Boss',
        guildevent: 'Guild Event'
      };

      const html = `
        <div class="events-list">
          ${eventsData.events.map(event => {
            const eventDate = new Date(event.eventTime);

            let statusClass = '';
            let statusText = '';

            if (event.isClosed) {
              statusClass = 'not-attending';
              statusText = 'Closed';
            } else if (event.hasRecordedAttendance) {
              statusClass = 'recorded';
              statusText = 'Attended';
            } else if (event.signupStatus === 'attending') {
              statusClass = 'attending';
              statusText = 'Going';
            } else if (event.signupStatus === 'not_attending') {
              statusClass = 'not-attending';
              statusText = 'Not Going';
            } else if (event.signupStatus === 'maybe') {
              statusClass = 'maybe';
              statusText = 'Maybe';
            }

            return `
              <div class="event-card">
                <div class="event-card-header">
                  <div class="event-icon">${eventTypeIcons[event.eventType] || 'üìÖ'}</div>
                  <div class="event-info">
                    <h3>${eventTypeNames[event.eventType] || event.eventType}${event.location ? ' - ' + event.location : ''}</h3>
                    <div class="event-time">${eventDate.toLocaleDateString()} ${eventDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                  </div>
                  ${statusText ? `<span class="event-status ${statusClass}">${statusText}</span>` : ''}
                </div>
                <div class="event-card-body">
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; color: var(--text-secondary); font-size: 13px;">
                    <span>+${event.bonusPoints} bonus</span>
                    <span>${event.rsvpAttendingCount} attending</span>
                    <span>${event.attendeesCount} recorded</span>
                  </div>
                  ${!event.isClosed && !event.hasRecordedAttendance ? `
                    <div class="event-actions">
                      ${!event.signupsClosed ? `
                        <button class="btn ${event.signupStatus === 'attending' ? 'btn-success' : 'btn-secondary'}" onclick="updateRsvp('${event._id}', 'attending')">Going</button>
                        <button class="btn ${event.signupStatus === 'maybe' ? 'btn-warning' : 'btn-secondary'}" onclick="updateRsvp('${event._id}', 'maybe')">Maybe</button>
                        <button class="btn ${event.signupStatus === 'not_attending' ? 'btn-danger' : 'btn-secondary'}" onclick="updateRsvp('${event._id}', 'not_attending')">Not Going</button>
                      ` : `
                        <span style="color: var(--text-muted); font-size: 13px;">Signups closed</span>
                      `}
                    </div>
                    ${event.canRecordAttendance && event.attendanceCode ? `
                      <div class="attendance-section" style="margin-top: 16px; padding: 16px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--accent-purple);">
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                          <div style="flex: 1;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">ATTENDANCE CODE</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-purple); letter-spacing: 4px;">${event.attendanceCode}</div>
                          </div>
                          <button class="btn btn-primary" onclick="recordAttendance('${event._id}', '${event.attendanceCode}')">Record Attendance</button>
                        </div>
                      </div>
                    ` : ''}
                  ` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      document.getElementById('events-content').innerHTML = html;
    }

    // Render static events
    function renderStaticEvents() {
      if (!eventsData.staticEvents || eventsData.staticEvents.length === 0) {
        document.getElementById('static-events-content').innerHTML = '<p style="color: var(--text-secondary);">No recurring events scheduled</p>';
        return;
      }

      // Sort by day of week
      const sortedEvents = [...eventsData.staticEvents].sort((a, b) => a.dayOfWeek - b.dayOfWeek);

      const html = sortedEvents.map(event => {
        // Calculate next occurrence of this static event in user's local time
        const now = new Date();
        const nextEvent = getNextEventOccurrence(event.dayOfWeek, event.hour, event.minute);
        const localTime = nextEvent.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const localDay = nextEvent.toLocaleDateString([], { weekday: 'long' });

        return `
          <div class="static-event-card">
            <div class="static-event-day">${localDay}</div>
            <div>
              <strong>${event.title || 'Untitled Event'}</strong>
              <br>
              <span style="color: var(--text-secondary); font-size: 13px;">${localTime} (Your Time)</span>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('static-events-content').innerHTML = html;
    }

    // Get next occurrence of a weekly event (converts from UK time)
    function getNextEventOccurrence(dayOfWeek, hour, minute) {
      // Create a date in UK timezone
      const now = new Date();

      // Get current day of week (0 = Sunday, 1 = Monday, etc.)
      const currentDay = now.getDay();

      // Calculate days until next occurrence
      let daysUntil = dayOfWeek - currentDay;
      if (daysUntil < 0) daysUntil += 7;

      // Create the next event date in UTC (UK time without DST adjustment for simplicity)
      // Note: UK is UTC+0 in winter, UTC+1 in summer (BST)
      // We'll use a rough approximation - events are stored in UK time
      const nextEvent = new Date(now);
      nextEvent.setDate(now.getDate() + daysUntil);

      // Set the time (assuming UK time is roughly UTC for now)
      // This creates a date object that JavaScript will display in the user's local timezone
      nextEvent.setUTCHours(hour, minute, 0, 0);

      // If the event already passed this week, move to next week
      if (daysUntil === 0 && nextEvent < now) {
        nextEvent.setDate(nextEvent.getDate() + 7);
      }

      return nextEvent;
    }

    // Update RSVP
    async function updateRsvp(eventId, status) {
      try {
        await apiCall('event-rsvp', 'POST', { eventId, status });
        showToast('RSVP updated', 'success');
        await loadEventsData();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Attendance modal
    function openAttendanceModal(eventId) {
      currentAttendanceEventId = eventId;
      document.getElementById('attendance-code').value = '';
      document.getElementById('attendance-modal').classList.add('show');
    }

    function closeAttendanceModal() {
      document.getElementById('attendance-modal').classList.remove('show');
      currentAttendanceEventId = null;
    }

    async function submitAttendance() {
      const code = document.getElementById('attendance-code').value;
      if (!code || code.length !== 4) {
        showToast('Please enter a 4-digit code', 'error');
        return;
      }

      try {
        await apiCall('event-attendance', 'POST', {
          eventId: currentAttendanceEventId,
          code
        });
        showToast('Attendance recorded!', 'success');
        closeAttendanceModal();
        await loadEventsData();
        await loadProfileData();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Record attendance directly with code
    async function recordAttendance(eventId, code) {
      try {
        await apiCall('event-attendance', 'POST', { eventId, code });
        showToast('Attendance recorded!', 'success');
        await loadEventsData();
        await loadProfileData();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Load wishlist data
    async function loadWishlistData() {
      try {
        wishlistData = await apiCall('wishlist');
        renderWishlistStatus();
        renderWishlist();
      } catch (error) {
        console.error('Error loading wishlist:', error);
        document.getElementById('wishlist-content').innerHTML = '<p class="error">Failed to load wishlist</p>';
      }
    }

    // Render wishlist status
    function renderWishlistStatus() {
      let statusHtml = '';

      if (wishlistData.isFrozen) {
        statusHtml = '<div style="padding: 12px; background: var(--dps-bg); border-radius: 8px; margin-bottom: 20px; color: var(--dps-color);">Wishlists are currently frozen. You cannot make changes.</div>';
      } else if (wishlistData.hasSubmitted) {
        statusHtml = '<div style="padding: 12px; background: var(--healer-bg); border-radius: 8px; margin-bottom: 20px; color: var(--healer-color);">Your wishlist has been submitted. Contact an admin to make changes.</div>';
      }

      document.getElementById('wishlist-status').innerHTML = statusHtml;
    }

    // Get item by ID
    function getItemById(itemId) {
      for (const category of Object.values(WISHLIST_ITEMS)) {
        const item = category.find(i => i.id === itemId);
        if (item) return item;
      }
      return null;
    }

    // Check if item is received
    function isItemReceived(itemId) {
      return wishlistData.givenItems.some(gi => gi.itemId === itemId);
    }

    // Render wishlist
    function renderWishlist() {
      const submission = wishlistData.submission || {};
      const canEdit = !wishlistData.isFrozen && !wishlistData.hasSubmitted;

      const sections = [
        { key: 'archbossWeapon', title: 'Archboss Weapons', items: WISHLIST_ITEMS.archbossWeapons, limit: WISHLIST_LIMITS.archbossWeapon, selected: submission.archbossWeapon || [] },
        { key: 'archbossArmor', title: 'Archboss Armor', items: WISHLIST_ITEMS.archbossArmors, limit: WISHLIST_LIMITS.archbossArmor, selected: submission.archbossArmor || [] },
        { key: 't3Weapons', title: 'T3 Weapons', items: WISHLIST_ITEMS.t3Weapons, limit: WISHLIST_LIMITS.t3Weapons, selected: submission.t3Weapons || [] },
        { key: 't3Armors', title: 'T3 Armors', items: WISHLIST_ITEMS.t3Armors, limit: WISHLIST_LIMITS.t3Armors, selected: submission.t3Armors || [] },
        { key: 't3Accessories', title: 'T3 Accessories', items: WISHLIST_ITEMS.t3Accessories, limit: WISHLIST_LIMITS.t3Accessories, selected: submission.t3Accessories || [] }
      ];

      const html = sections.map(section => `
        <div class="wishlist-section">
          <div class="wishlist-section-title">
            ${section.title}
            <span class="limit">${section.selected.length}/${section.limit}</span>
          </div>
          <div class="wishlist-items">
            ${section.items.map(item => {
              const isSelected = section.selected.includes(item.id);
              const received = isItemReceived(item.id);
              const atLimit = section.selected.length >= section.limit && !isSelected;
              const disabled = !canEdit || atLimit || received;

              return `
                <div class="wishlist-item ${isSelected ? 'selected' : ''} ${received ? 'received' : ''} ${disabled && !received ? 'disabled' : ''}"
                     onclick="${!disabled ? `toggleWishlistItem('${section.key}', '${item.id}')` : ''}">
                  <img src="${item.icon}" alt="${item.name}" loading="lazy">
                  <div class="item-name">${item.name}</div>
                  <div class="item-category">${item.category || item.type}</div>
                  ${received ? '<div class="received-badge">Received</div>' : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `).join('');

      const actionsHtml = canEdit ? `
        <div class="wishlist-actions">
          <button class="btn btn-secondary" onclick="clearWishlist()">Clear All</button>
          <button class="btn btn-primary" onclick="submitWishlist()">Submit Wishlist</button>
        </div>
      ` : '';

      document.getElementById('wishlist-content').innerHTML = html + actionsHtml;
    }

    // Toggle wishlist item
    async function toggleWishlistItem(category, itemId) {
      if (wishlistData.isFrozen || wishlistData.hasSubmitted) return;

      const submission = wishlistData.submission || {};
      let items = submission[category] || [];

      const index = items.indexOf(itemId);
      if (index > -1) {
        items.splice(index, 1);
      } else {
        if (items.length >= WISHLIST_LIMITS[category]) {
          showToast(`Maximum ${WISHLIST_LIMITS[category]} item(s) for this category`, 'error');
          return;
        }
        items.push(itemId);
      }

      try {
        await apiCall('update-wishlist', 'POST', {
          archbossWeapon: category === 'archbossWeapon' ? items : submission.archbossWeapon,
          archbossArmor: category === 'archbossArmor' ? items : submission.archbossArmor,
          t3Weapons: category === 't3Weapons' ? items : submission.t3Weapons,
          t3Armors: category === 't3Armors' ? items : submission.t3Armors,
          t3Accessories: category === 't3Accessories' ? items : submission.t3Accessories
        });
        await loadWishlistData();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Clear wishlist
    async function clearWishlist() {
      if (wishlistData.isFrozen || wishlistData.hasSubmitted) return;

      try {
        await apiCall('update-wishlist', 'POST', {
          archbossWeapon: [],
          archbossArmor: [],
          t3Weapons: [],
          t3Armors: [],
          t3Accessories: []
        });
        showToast('Wishlist cleared', 'success');
        await loadWishlistData();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Submit wishlist
    async function submitWishlist() {
      if (wishlistData.isFrozen || wishlistData.hasSubmitted) return;

      const submission = wishlistData.submission;
      if (!submission ||
          (!submission.archbossWeapon?.length &&
           !submission.archbossArmor?.length &&
           !submission.t3Weapons?.length &&
           !submission.t3Armors?.length &&
           !submission.t3Accessories?.length)) {
        showToast('Please select at least one item', 'error');
        return;
      }

      if (!confirm('Are you sure you want to submit your wishlist? You will not be able to change it without admin help.')) {
        return;
      }

      try {
        await apiCall('update-wishlist', 'POST', {
          archbossWeapon: submission.archbossWeapon || [],
          archbossArmor: submission.archbossArmor || [],
          t3Weapons: submission.t3Weapons || [],
          t3Armors: submission.t3Armors || [],
          t3Accessories: submission.t3Accessories || [],
          submit: true
        });
        showToast('Wishlist submitted!', 'success');
        await loadWishlistData();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Roster state
    let rosterData = null;
    let rosterSortField = 'name';
    let rosterSortAscending = true;

    // Load roster data
    async function loadRosterData() {
      try {
        rosterData = await apiCall('roster');
        renderRoster();
        setupRosterSortButtons();
      } catch (error) {
        console.error('Error loading roster:', error);
        document.getElementById('roster-content').innerHTML = '<p class="error">Failed to load roster</p>';
      }
    }

    // Setup roster sort buttons
    function setupRosterSortButtons() {
      document.querySelectorAll('.roster-sort-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sortField = btn.dataset.sort;

          // Toggle ascending/descending if same field
          if (rosterSortField === sortField) {
            rosterSortAscending = !rosterSortAscending;
          } else {
            rosterSortField = sortField;
            // Default sort direction based on field type
            rosterSortAscending = sortField === 'name' || sortField === 'role' || sortField === 'classes';
          }

          // Update active button and arrow
          document.querySelectorAll('.roster-sort-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // Update arrow direction
          const arrow = btn.querySelector('.sort-arrow');
          if (arrow) {
            arrow.textContent = rosterSortAscending ? '‚ñ≤' : '‚ñº';
          }

          renderRoster();
        });
      });
    }

    // Sort roster players
    function sortRosterPlayers(players) {
      const sorted = [...players];
      const roleOrder = { tank: 0, healer: 1, dps: 2 };

      sorted.sort((a, b) => {
        let comparison = 0;

        switch (rosterSortField) {
          case 'name':
            comparison = a.displayName.localeCompare(b.displayName);
            break;
          case 'cp':
            comparison = b.cp - a.cp;
            break;
          case 'role':
            comparison = roleOrder[a.role] - roleOrder[b.role];
            if (comparison === 0) comparison = a.displayName.localeCompare(b.displayName);
            break;
          case 'classes':
            const aWeapons = `${a.weapon1}/${a.weapon2}`;
            const bWeapons = `${b.weapon1}/${b.weapon2}`;
            comparison = aWeapons.localeCompare(bWeapons);
            break;
          case 'totalEvents':
            comparison = b.totalEvents - a.totalEvents;
            break;
          case 'attendance':
            comparison = b.attendancePercent - a.attendancePercent;
            break;
          default:
            comparison = 0;
        }

        return rosterSortAscending ? comparison : -comparison;
      });

      return sorted;
    }

    // Format CP with K/M suffixes
    function formatCP(cp) {
      if (!cp || cp === 0) return '0';
      if (cp >= 1000000) return `${(cp / 1000000).toFixed(1)}M`;
      if (cp >= 1000) return `${(cp / 1000).toFixed(1)}K`;
      return cp.toString();
    }

    // Get attendance class
    function getAttendanceClass(percent) {
      if (percent >= 70) return 'roster-attendance-good';
      if (percent >= 40) return 'roster-attendance-medium';
      return 'roster-attendance-low';
    }

    // Render roster
    function renderRoster() {
      if (!rosterData || !rosterData.players || rosterData.players.length === 0) {
        document.getElementById('roster-content').innerHTML = `
          <div class="no-events">
            <div class="no-events-icon">üë•</div>
            <p>No players in the roster yet</p>
          </div>
        `;
        return;
      }

      const summary = rosterData.summary;
      const sortedPlayers = sortRosterPlayers(rosterData.players);

      const summaryHtml = `
        <div class="roster-summary">
          <div class="roster-summary-item">
            <div class="roster-summary-value">${summary.totalPlayers}</div>
            <div class="roster-summary-label">Players</div>
          </div>
          <div class="roster-summary-item">
            <div class="roster-summary-value">${formatCP(summary.totalCP)}</div>
            <div class="roster-summary-label">Total CP</div>
          </div>
          <div class="roster-summary-item">
            <div class="roster-summary-value" style="color: var(--tank-color);">${summary.tanks}</div>
            <div class="roster-summary-label">Tanks</div>
          </div>
          <div class="roster-summary-item">
            <div class="roster-summary-value" style="color: var(--healer-color);">${summary.healers}</div>
            <div class="roster-summary-label">Healers</div>
          </div>
          <div class="roster-summary-item">
            <div class="roster-summary-value" style="color: var(--dps-color);">${summary.dps}</div>
            <div class="roster-summary-label">DPS</div>
          </div>
        </div>
      `;

      const tableHtml = `
        <div style="overflow-x: auto;">
          <table class="roster-table">
            <thead>
              <tr>
                <th>Player</th>
                <th>Role</th>
                <th>Weapons</th>
                <th>CP</th>
                <th>Total Events</th>
                <th>Attendance</th>
              </tr>
            </thead>
            <tbody>
              ${sortedPlayers.map(player => {
                const roleClass = `roster-role-${player.role}`;
                const roleEmoji = player.role === 'tank' ? 'üõ°Ô∏è' : player.role === 'healer' ? 'üíö' : '‚öîÔ∏è';
                const roleDisplay = player.role.charAt(0).toUpperCase() + player.role.slice(1);
                const attendanceClass = getAttendanceClass(player.attendancePercent);

                return `
                  <tr>
                    <td>
                      <div class="roster-player-name">
                        ${player.avatarUrl ? `<img src="${player.avatarUrl}" alt="" class="roster-avatar">` : ''}
                        <span>${player.displayName}</span>
                      </div>
                    </td>
                    <td>
                      <span class="roster-role-badge ${roleClass}">
                        ${roleEmoji} ${roleDisplay}
                      </span>
                    </td>
                    <td class="roster-weapons">${player.weapon1} / ${player.weapon2}</td>
                    <td class="roster-cp">${formatCP(player.cp)}</td>
                    <td class="roster-stat">${player.totalEvents}</td>
                    <td class="roster-stat ${attendanceClass}">${player.attendancePercent}%</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('roster-content').innerHTML = summaryHtml + tableHtml;
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
